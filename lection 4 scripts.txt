psql \! chcp 1251


CREATE or replace PROCEDURE l4start() 
language sql as $$
drop table if exists accounts;

create table accounts(
id int generated by default as identity,
name varchar(100) not null,
balance dec(15,2) not null,
primary key(id)
);

$$;

CREATE or replace PROCEDURE l4start2() 
language sql as $$


insert into accounts(name, balance)
values ('Bob',25000); 

insert into accounts(name, balance)
values ('Alice',15000); 

$$;


create or replace procedure transfer(
sender int,
receiver int,
amount dec(15,2) 
)

language plpgsql

as $$


begin


update accounts set balance=balance+amount
where id=receiver;

update accounts set balance=balance-amount
where id=sender;

commit;

end;
$$;

create or replace function log_account_change()
 returns trigger
 language plpgsql
 as
 $$
 begin
 
 if  NEW.balance<>OLD.balance
 then
     insert into accounts_log(account_id, value,  change) 
	 values(OLD.id, NEW.balance-OLD.balance, CURRENT_TIMESTAMP);
 end if;
 
 return NEW;
 
 end;
 $$;
 
 
 CREATE TRIGGER balance_changes
  BEFORE UPDATE
  ON accounts
  FOR EACH ROW
  EXECUTE PROCEDURE log_account_change();
 
 

